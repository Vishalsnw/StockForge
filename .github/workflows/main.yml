name: Auto-fix Missing CSS Imports

on:
  workflow_dispatch:
  push:
    branches: [main, master]

jobs:
  autofix-css-imports:
    runs-on: ubuntu-latest
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          ref: ${{ github.head_ref }}
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install GNU sed (for macOS compatibility)
        run: sudo apt-get update && sudo apt-get install -y sed

      - name: Auto-inject missing CSS imports
        run: |
          cd frontend/src
          find . -type f \( -name "*.js" -o -name "*.jsx" \) > js_files.txt
          injected_any=0
          while read jsfile; do
            base=$(basename "$jsfile" .js)
            basex=$(basename "$jsfile" .jsx)
            cssfile="$(dirname "$jsfile")/$base.css"
            cssfilex="$(dirname "$jsfile")/$basex.css"
            target=""
            [ -f "$cssfile" ] && target="$base.css"
            [ -f "$cssfilex" ] && target="$basex.css"
            if [ -n "$target" ]; then
              # Check if already imported
              if ! grep -q "import [\"']\\.?\\/?$target[\"']" "$jsfile"; then
                # Insert import at the first line
                sed -i "1iimport './$target';" "$jsfile"
                echo "Injected import './$target'; into $jsfile"
                injected_any=1
              fi
            fi
          done < js_files.txt
          exit $injected_any

      - name: Commit and Push changes
        if: ${{ failure() }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add .
          git commit -m "chore: auto-inject missing component CSS imports"
          git push
