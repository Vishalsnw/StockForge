name: StockForge Auto-Fix

on:
  workflow_dispatch:
    inputs:
      user_name:
        description: Target User
        required: false
        default: Vishalsnw
        type: string
      
  push:
    branches: 
      - main
    paths: 
      - frontend/src/hooks/useBotMarket.js
      - src/hooks/useBotMarket.js

jobs:
  fix-duplicates:
    name: Fix Issues
    runs-on: ubuntu-latest
    
    steps:
      - name: Display Info
        run: |
          echo "StockForge Auto-Fix"
          echo "User: ${{ inputs.user_name || 'Vishalsnw' }}"
          echo "UTC Time: 2025-06-12 14:36:05"

      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Fix Duplicates
        run: |
          if [ -f "frontend/src/hooks/useBotMarket.js" ]; then
            FILE="frontend/src/hooks/useBotMarket.js"
          elif [ -f "src/hooks/useBotMarket.js" ]; then
            FILE="src/hooks/useBotMarket.js"
          else
            echo "Target file not found"
            exit 0
          fi
          
          echo "Processing: $FILE"
          
          # Count duplicates
          USER_COUNT=$(grep -c "const currentUser =" "$FILE" || echo "0")
          echo "Found $USER_COUNT currentUser declarations"
          
          if [ $USER_COUNT -gt 1 ]; then
            echo "Removing duplicates..."
            
            # Remove our duplicate patterns only
            sed -i '/const currentUser.*Vishalsnw/d' "$FILE"
            sed -i '/const currentDateTimeUTC.*2025-/d' "$FILE"
            sed -i '/const currentDate.*2025-/d' "$FILE"
            sed -i '/const currentTime.*[0-9][0-9]:[0-9][0-9]/d' "$FILE"
            sed -i '/\/\/ ===== CURRENT INFO/d' "$FILE"
            sed -i '/\/\/ REMOVED DUPLICATE/d' "$FILE"
            
            # Verify fix
            NEW_COUNT=$(grep -c "const currentUser =" "$FILE" || echo "0")
            echo "After fix: $NEW_COUNT currentUser declarations"
            
            if [ $NEW_COUNT -eq 1 ]; then
              echo "SUCCESS: Duplicates removed"
            else
              echo "WARNING: Unexpected count"
            fi
          else
            echo "No duplicates found"
          fi

      - name: Test Build
        run: |
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm install
            npm run build
          elif [ -f "package.json" ]; then
            npm install
            npm run build
          fi

      - name: Commit
        run: |
          git config user.email "action@github.com"
          git config user.name "StockForge-Bot"
          
          git add .
          
          if ! git diff --staged --quiet; then
            git commit -m "Fix duplicates - Vishalsnw - 2025-06-12 14:36:05"
            git push
            echo "Changes pushed"
          else
            echo "No changes"
          fi

      - name: Summary
        run: |
          echo "Fix completed"
          echo "User: Vishalsnw"
          echo "Time: 2025-06-12 14:36:05"
