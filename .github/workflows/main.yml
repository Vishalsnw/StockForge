name: StockForge Auto-Fix Duplicates

on:
  workflow_dispatch:
    inputs:
      fix_type:
        description: Type of fix to apply
        required: true
        default: remove_duplicates
        type: choice
        options:
          - remove_duplicates
          - update_timestamps
          - full_cleanup
      user_name:
        description: Target User
        required: false
        default: Vishalsnw
        type: string
      
  push:
    branches: 
      - main
    paths: 
      - frontend/src/hooks/useBotMarket.js
      - src/hooks/useBotMarket.js

jobs:
  auto-fix-duplicates:
    name: Fix Duplicate Declarations
    runs-on: ubuntu-latest
    
    steps:
      - name: Display Info
        run: |
          echo "StockForge Auto-Fix Workflow"
          echo "User: ${{ inputs.user_name || 'Vishalsnw' }}"
          echo "Fix Type: ${{ inputs.fix_type || 'remove_duplicates' }}"

      - name: Checkout Repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Detect and Fix Duplicates
        run: |
          # Find target file
          if [ -f "frontend/src/hooks/useBotMarket.js" ]; then
            TARGET_FILE="frontend/src/hooks/useBotMarket.js"
          elif [ -f "src/hooks/useBotMarket.js" ]; then
            TARGET_FILE="src/hooks/useBotMarket.js"
          else
            echo "ERROR: useBotMarket.js not found!"
            exit 1
          fi
          
          echo "Target file: $TARGET_FILE"
          
          # Quick analysis
          USER_COUNT=$(grep -c "const currentUser =" "$TARGET_FILE" || echo "0")
          DATETIME_COUNT=$(grep -c "const currentDateTimeUTC =" "$TARGET_FILE" || echo "0")
          
          echo "Found $USER_COUNT currentUser declarations"
          echo "Found $DATETIME_COUNT currentDateTimeUTC declarations"
          
          # Only fix if duplicates exist
          if [ $USER_COUNT -gt 1 ] || [ $DATETIME_COUNT -gt 1 ]; then
            echo "Duplicates detected, fixing..."
            
            # Direct inline fix - no external files
            # Remove only our duplicate patterns (not original code)
            sed -i '/const currentUser.*Vishalsnw/d' "$TARGET_FILE"
            sed -i '/const currentDateTimeUTC.*2025-/d' "$TARGET_FILE" 
            sed -i '/const currentDate.*2025-/d' "$TARGET_FILE"
            sed -i '/const currentTime.*[0-9][0-9]:[0-9][0-9]:[0-9][0-9]/d' "$TARGET_FILE"
            
            # Remove our comment blocks
            sed -i '/\/\/ ===== CURRENT INFO (Updated) =====/d' "$TARGET_FILE"
            
            # Remove any commented duplicates
            sed -i '/\/\/ REMOVED DUPLICATE:/d' "$TARGET_FILE"
            
            # Verification
            USER_COUNT_AFTER=$(grep -c "const currentUser =" "$TARGET_FILE" || echo "0")
            echo "After fix: $USER_COUNT_AFTER currentUser declarations"
            
            if [ $USER_COUNT_AFTER -eq 1 ]; then
              echo "SUCCESS: Fixed duplicates"
            else
              echo "WARNING: Unexpected count after fix"
            fi
          else
            echo "No duplicates found, file is clean"
          fi

      - name: Test Build
        run: |
          echo "Testing build after fix..."
          
          if [ -f "frontend/package.json" ]; then
            cd frontend
            npm install
            npm run build
          elif [ -f "package.json" ]; then
            npm install  
            npm run build
          else
            echo "No package.json found, skipping build test"
          fi

      - name: Commit Changes
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "StockForge-Bot"
          
          # Only add the main file, not temp files
          git add frontend/src/hooks/useBotMarket.js || git add src/hooks/useBotMarket.js || echo "No target file to add"
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            git commit -m "Fix: Remove duplicate declarations - Vishalsnw"
            git push
            echo "Changes committed"
          fi

      - name: Cleanup
        run: |
          echo "Cleaning up any temp files..."
          rm -f fix_*.js fix_*.sh fix_*.cjs *.backup* fix_summary.md
          echo "Cleanup complete"
